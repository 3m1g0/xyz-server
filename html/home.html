
<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>XYZ Innovations</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Bootstrap core CSS -->
    <link href="https://mdbootstrap.com/live/_MDB/css/compiled.min.css" rel="stylesheet">
    <meta charset='utf-8' />
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.0/mapbox-gl-draw.css' type='text/css'/>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.0/mapbox-gl.css' rel='stylesheet' />
    <link href='../css/map-page.css' rel='stylesheet' />
    <style>
        #map { position:absolute; left:0; top:62px; bottom:0; width:100%; }
    </style>

    <style>
        .bg-skin-lp {
            background-size: cover; 
            background-repeat: no-repeat; 
            background-position: center center; 
            background-attachment: fixed;
        }
    </style>

    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.0/mapbox-gl.js'></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.0/mapbox-gl-draw.js'></script>
    <script type="text/javascript" src="../js/map-utils.js"></script>
</head>

<body class="fixed-sn light-blue-skin bg-skin-lp">
    <!--Double navigation-->
    <header>
        <!-- Sidebar navigation -->
        <ul id="slide-out" class="side-nav fixed sn-bg-1 custom-scrollbar">
            <!-- Logo -->
            <li>
                <div class="logo-wrapper waves-light">
                    <a href="#"><img src="https://mdbootstrap.com/img/logo/mdb-transparent.png" class="img-fluid flex-center"></a>
                </div>
            </li>
            <!--/. Logo -->
            <!--Social-->
            <li>
                <ul class="social">
                    <li><a class="icons-sm fb-ic"><i class="fa fa-facebook"> </i></a></li>
                    <li><a class="icons-sm pin-ic"><i class="fa fa-pinterest"> </i></a></li>
                    <li><a class="icons-sm gplus-ic"><i class="fa fa-google-plus"> </i></a></li>
                    <li><a class="icons-sm tw-ic"><i class="fa fa-twitter"> </i></a></li>
                </ul>
            </li>
            <!--/Social-->
            <!--Search Form-->
            <li>
                <form class="search-form" role="search">
                    <div class="form-group waves-light">
                        <input type="text" class="form-control" placeholder="Search">
                    </div>
                </form>
            </li>
            <!--/.Search Form-->
            <!-- Side navigation links -->
            <li>
                <ul class="collapsible collapsible-accordion">
                    <li><a class="collapsible-header waves-effect arrow-r"><i class="fa fa-chevron-right"></i> Submit blog<i class="fa fa-angle-down rotate-icon"></i></a>
                        <div class="collapsible-body">
                            <ul>
                                <li><a href="#" class="waves-effect">Submit listing</a>
                                </li>
                                <li><a href="#" class="waves-effect">Registration form</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li><a class="collapsible-header waves-effect arrow-r"><i class="fa fa-hand-pointer-o"></i> Instruction<i class="fa fa-angle-down rotate-icon"></i></a>
                        <div class="collapsible-body">
                            <ul>
                                <li><a href="#" class="waves-effect">For bloggers</a>
                                </li>
                                <li><a href="#" class="waves-effect">For authors</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li><a class="collapsible-header waves-effect arrow-r"><i class="fa fa-eye"></i> About<i class="fa fa-angle-down rotate-icon"></i></a>
                        <div class="collapsible-body">
                            <ul>
                                <li><a href="#" class="waves-effect">Introduction</a>
                                </li>
                                <li><a href="#" class="waves-effect">Monthly meetings</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li><a class="collapsible-header waves-effect arrow-r"><i class="fa fa-envelope-o"></i> Contact me<i class="fa fa-angle-down rotate-icon"></i></a>
                        <div class="collapsible-body">
                            <ul>
                                <li><a href="#" class="waves-effect">FAQ</a>
                                </li>
                                <li><a href="#" class="waves-effect">Write a message</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
            <!--/. Side navigation links -->
            <div class="sidenav-bg mask-strong"></div>
        </ul>
        <!--/. Sidebar navigation -->
        <!-- Navbar -->
        <nav class="navbar fixed-top navbar-toggleable-md navbar-expand-lg scrolling-navbar double-nav">
            <!-- SideNav slide-out button -->
            <div class="float-xs-left">
                <a href="#" data-activates="slide-out" class="button-collapse"><i class="fa fa-bars"></i></a>
            </div>
            <!-- Breadcrumb-->
            <div class="breadcrumb-dn mr-auto">
                <p><strong>XYZ Innovations</strong></p>
            </div>
            <ul class="nav navbar-nav nav-flex-icons ml-auto">
                <li class="nav-item">
                    <a class="nav-link"><i class="fa fa-envelope"></i> <span class="hidden-sm-down">Contact</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link"><i class="fa fa-comments-o"></i> <span class="hidden-sm-down">Support</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link"><i class="fa fa-user"></i> <span class="hidden-sm-down">Account</span></a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Dropdown
                    </a>
                    <div class="dropdown-menu dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                        <a class="dropdown-item" href="#">Action</a>
                        <a class="dropdown-item" href="#">Another action</a>
                        <a class="dropdown-item" href="#">Something else here</a>
                    </div>
                </li>
            </ul>
        </nav>
        <!-- /.Navbar -->
    </header>
    <!--/.Double navigation-->
    
    <!--Main layout-->
    <main>
        
        <div id='map'></div>

        <!--Modal: Subscription From-->
        <div class="modal fade" id="modalSubscription" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog cascading-modal" role="document">
                <!--Content-->
                <div class="modal-content">

                    <!--Header-->
                    <div class="modal-header light-blue darken-3 white-text">
                        <button type="button" class="close waves-effect waves-light" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="title"><i class="fa fa-newspaper-o"></i> New annotation</h4>
                    </div>
                    <!--Body-->
                    <div class="modal-body mb-0">

                        <div class="md-form form-sm">
                            <i class="fa fa-tag prefix"></i>
                            <input type="text" id="annotationTitleField" class="form-control">
                            <label for="form27">Title</label>
                        </div>

                        <div class="md-form form-sm">
                            <i class="fa fa-pencil prefix"></i>
                            <textarea type="text" id="annotationDescField" class="md-textarea mb-0"></textarea>
                            <label for="form8">Description</label>
                        </div>

                        <div class="text-center mt-1-half">
                            <button id="newAnnoSubmit" class="btn btn-info mb-1">Submit <i class="fa fa-check ml-1"></i></button>
                        </div>

                    </div>
                </div>
                <!--/.Content-->
            </div>
        </div>
        <!--Modal: Subscription From-->

        <!-- Modal Message-->
        <div class="modal fade top" id="basicExample" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-frame modal-top" role="document">
                <!--Content-->
                <div class="modal-content">
                    <!--Body-->
                    <div class="modal-body">
                        The area or selected polygon is 123456 Sq. Mts.
                    </div>
                </div>
                <!--/.Content-->
            </div>
        </div>
        <!-- Modal Message-->
        
    </main>
    <!--/Main layout-->

    <!-- SCRIPTS -->
    <!-- JQuery -->
    <script type="text/javascript" src="https://mdbootstrap.com/live/_MDB/js/compiled.min.js"></script>
    <script>

        // Sidenav init
        var container = document.getElementById('slide-out');
        Ps.initialize(container, {
          wheelSpeed: 2,
          wheelPropagation: true,
          minScrollbarLength: 20
        });
        
        new WOW().init();
    
    </script>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoia3R0aGVhbG1pZ2h0eSIsImEiOiJjajRlZTd0aTkwMjNyMndwcTkxb2ZvcWM1In0.UQPL-sMo5nj0qQLNHmgpaA';
        var tileset = 'ktthealmighty.bestvvxl';
        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: {
                "version": 8,
                "sources": {
                    "satellite-tiles": {
                        "type": "raster",
                        "url": "mapbox://" + "mapbox.satellite",
                        "tileSize": 256
                    },
                    "raster-tiles": {
                        "type": "raster",
                        "url": "mapbox://" + tileset,
                        "tileSize": 256
                    }
                },
                "layers": [{
                    "id": "satellite",
                    "type": "raster",
                    "source": "satellite-tiles",
                    "minzoom": 0,
                    "maxzoom": 22
                },
                {
                    "id": "polavaram",
                    "type": "raster",
                    "source": "raster-tiles",
                    "minzoom": 0,
                    "maxzoom": 22
                }]
            },
            center: [81.638, 17.290], // starting position
            zoom: 16 // starting zoom
        });

        // Add zoom and rotation controls to the map.
        map.addControl(new mapboxgl.NavigationControl());
        var draw = new MapboxDraw({
            displayControlsDefault: false,
            controls: {
                polygon: true,
                point: true,
                trash: true
            }
        });
        map.addControl(draw);
        var featureIds;
        var geoJSON;
        var currentFeature;
        var isSubmitClicked = false;
        map.on('draw.create', function (e) {
            currentFeature = e.features[0];
            $('#modalSubscription').modal('show');
        });

        map.on('draw.update', function (e) {
            if(e.features.length > 0) {
                updateFeatures(e.features[0]);
            }
        });

        map.on('draw.delete', function (e) {
            console.log(e.features);
            if(e.features.length > 0) {
                deleteFeatures(e.features[0]);
            }
        });

        map.on('draw.selectionchange', function(e) {
            if(e.features.length > 0) {
                var feature = getFeatureForId(e.features[0].id);
                if(feature) {
                    //$("#basicExample").modal('show');
                }
            }

        });
        
        map.on('load', function(e) {
              map.loadImage('https://cdn0.iconfinder.com/data/icons/small-n-flat/24/678135-sticky-note-128.png', function(error, image) {
                if (error) throw error;
                map.addImage('cat', image);
                $.ajax({
                    type: 'GET',
                    url: '/annotations',
                    contentType: "application/json",
                    dataType: "json",
                    success: function(data) {
                        geoJSON = data;
                        changeCoordinatesForPoints();
                        console.log("Data fetched!");
                        featureIds = draw.add(data);
                    }
                });
            });
        });

        $('#modalSubscription').on('show.bs.modal', function (e1) {
            $(this).find("text,input,textarea,select").val('').end();
        });
        $('#modalSubscription').on('hidden.bs.modal', function (e1) {
            if(isSubmitClicked && $('#annotationTitleField').val() != '') {
                if(currentFeature != undefined) {
                    console.log('Coming here ' + currentFeature.id);
                    featureIds.push(currentFeature.id);
                    currentFeature.properties.title = $('#annotationTitleField').val();
                    currentFeature.properties.description = $('#annotationDescField').val();
                    uploadFeatures(currentFeature);
                }
            } else {
                draw.delete([currentFeature.id]);
            }
        })
        $('#newAnnoSubmit').on('click', function() {
            if($('#annotationTitleField').val() != '') {
                $("#modalSubscription").modal('hide');
                isSubmitClicked = true;
            }
        });

    </script>

</body>

</html>
